{% extends 'testtemp/layout.html' %}
{% block content %}
  <!-- 新規タスク追加Modal -->
  <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h1 class="modal-title fs-5" id="addTaskModalLabel">新規タスク追加</h1>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <form id="addTaskForm">
            <div class="row mb-3">
              <div class="col-12 col-md-3">
                <label for="title" class="form-label">タスク名：</label>
              </div>
              <div class="col-12 col-md-9">
                <input type="text" name="title" id="title" class="form-control" required placeholder="タスク名を入力してください">
                <div class="error" id="titleError"></div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-12 col-md-3">
                <label for="dead_date" class="form-label">期限日：</label>
              </div>
              <div class="col-12 col-md-9">
                <input type="date" name="dead_date" id="dead_date" class="form-control" required>
                <div class="error" id="deaddateError"></div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-12 col-md-3">
                <label for="dead_time" class="form-label">期限時間：</label>
              </div>
              <div class="col-12 col-md-9">
                <input type="time" name="dead_time" id="dead_time" class="form-control" required>
                <div class="error" id="deadtimeError"></div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-12 col-md-3">
                <label class="form-label">重要度：</label>
              </div>
              <div class="col-12 col-md-9">
                <div class="d-flex gap-4">
                  <div class="form-check">
                    <input type="radio" name="importance" id="importanceLow" value="0" class="form-check-input">
                    <label class="form-check-label" for="importanceLow">低 ★</label>
                  </div>
                  <div class="form-check">
                    <input type="radio" name="importance" id="importanceMedium" value="1" class="form-check-input" checked>
                    <label class="form-check-label" for="importanceMedium">中 ★★</label>
                  </div>
                  <div class="form-check">
                    <input type="radio" name="importance" id="importanceHigh" value="2" class="form-check-input">
                    <label class="form-check-label" for="importanceHigh">高 ★★★</label>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="submit" class="btn btn-success" id="saveNewTask">追加</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 編集タスク用Modal -->
  <div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-medium text-white">
          <h1 class="modal-title fs-5" id="editTaskModalLabel">タスクを編集</h1>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <form id="editTaskForm" class="edit_task_form">
            <!-- タスクIDを保存（非表示） -->
            <input type="hidden" id="editTaskId" name="task_id">
            
            <div class="row mb-3">
              <div class="col-12 col-md-4">
                <label for="editTitle" class="form-label">タスク名：</label>
              </div>
              <div class="col-12 col-md-8">
                <input type="text" name="title" id="editTitle" class="form-control" required>
                <div class="error" id="editTitleError"></div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-12 col-md-4">
                <label for="editDeadDate" class="form-label">期限日：</label>
              </div>
              <div class="col-12 col-md-8">
                <input type="date" name="dead_date" id="editDeadDate" class="form-control" required>
                <div class="error" id="editDeadDateError"></div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-12 col-md-4">
                <label for="editDeadTime" class="form-label">期限時間：</label>
              </div>
              <div class="col-12 col-md-8">
                <input type="time" name="dead_time" id="editDeadTime" class="form-control" required>
                <div class="error" id="editDeadTimeError"></div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-12 col-md-4">
                <label class="form-label">重要度：</label>
              </div>
              <div class="col-12 col-md-8">
                <div class="d-flex gap-3">
                  <div class="form-check">
                    <input type="radio" name="editImportance" id="editImportanceLow" value="0" class="form-check-input">
                    <label class="form-check-label" for="editImportanceLow">低</label>
                  </div>
                  <div class="form-check">
                    <input type="radio" name="editImportance" id="editImportanceMedium" value="1" class="form-check-input">
                    <label class="form-check-label" for="editImportanceMedium">中</label>
                  </div>
                  <div class="form-check">
                    <input type="radio" name="editImportance" id="editImportanceHigh" value="2" class="form-check-input">
                    <label class="form-check-label" for="editImportanceHigh">高</label>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="saveEditTask">更新</button>
        </div>
      </div>
    </div>
  </div>

  <!-- タスク削除Modal -->
  <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <div class="d-flex align-items-center">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <h1 class="modal-title fs-5 fw-bold" id="deleteTaskModalLabel">タスク削除確認</h1>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <div class="modal-body p-4">
        <!-- 削除対象タスク表示 -->
        <div class="card border-danger mb-3">
          <div class="card-header text-center bg-danger text-white py-3">
            <h5 class="mb-0">削除対象</h5>
          </div>
          <div class="card-body p-4 text-center">
            <h4 class="text-dark mb-0" id="delete_task_title">タスク名</h4>
            <div class="row justify-content-center mb-0">
              <div class="col-auto">
                <div class="d-flex flex-column align-items-center text-muted">
                  <small class="text-uppercase fw-bold mb-1" style="font-size: 0.8rem; color: #6c757d;">期限日</small>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-calendar-alt me-2" style="color: #dc3545;"></i>
                    <span class="fw-semibold" id="delete_task_date" style="font-size: 0.95rem;">2025-01-15</span>
                  </div>
                </div>
              </div>
              <div class="col-auto mx-3">
                <div class="d-flex flex-column align-items-center text-muted">
                  <small class="text-uppercase fw-bold mb-1" style="font-size: 0.7rem; color: #6c757d;">時間</small>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-clock me-2" style="color: #dc3545;"></i>
                    <span class="fw-semibold" id="delete_task_time" style="font-size: 0.95rem;">14:30</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
        
        <!-- 確認メッセージ -->
        <div class="text-center mb-4">
          <p class="fs-5 text-dark mb-2">本当に削除しますか？</p>
          <p class="text-muted small mb-0">
            <i class="fas fa-info-circle me-1"></i>
            この操作は元に戻すことができません
          </p>
        </div>
      </div>
      
      <div class="modal-footer justify-content-center gap-3 p-4">
        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
          キャンセル
        </button>
        <button type="button" class="btn btn-danger px-4" id="deleteConfirmTask">
          削除
        </button>
      </div>
    </div>
  </div>
</div>

  <!-- 期限タスク通知odal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">期限が近づいたタスクあり</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <div class="table-responsive">
            <table width="100%" class="table table-lignt table-bordered mb-0" id="nc-table">
              <thead>
                <tr>
                  <th width="45%" class="text-center align-middle">タスク名</th>
                  <th width="20%" class="text-center align-middle">期限日</th>
                  <th width="10%" class="text-center align-middle">時間</th>
                  <th width="10%" class="text-center align-middle">重要度</th>
                  <th width="15%" class="text-center align-middle">状態</th>
                </tr>
              </thead>
              <tbody class="modal-tasks">
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary close-modal" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveDeadlineChanges">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container vh-100 px-2 py-0">
    <div class="row h-auto justify-content-center align-items-start mb-4">
      <div class="col-12 col-md-8 col-lg-6 col-xl-5">
        <div class="deadline-set d-flex flex-row justify-content-end align-items-end mb-1">
            <a href="{{ url_for('setting') }}"><button type="button" class="btn btn-outline-primary btn-sm border-2">期限時間設定</button></a>
        </div>
        <div class="sort_buttons d-flex flex-row justify-content-end align-items-end px-0 py-1 gap-2"> 
          <h4 class="font-size-m m-auto">未完了タスク</h4>
          {# <a href="{{ url_for('button_click', flg=1) }}"><button type="button" class="btn btn-outline-warning btn-sm border-2" id="nc-sort-importance">重要度順</button></a> #}
          <button type="button" class="btn btn-outline-warning btn-sm border-2" id="nc-sort-importance">重要度順</button>
          {# <a href="{{ url_for('button_click', flg=2) }}"><button type="button" class="btn btn-outline-secondary btn-sm border-2" id="nc-sort-day">日付順</button></a> #}
          <button type="button" class="btn btn-outline-secondary btn-sm border-2" id="nc-sort-day">日付順</button>
        </div>
        <table width="100%" class="table table-light table-hover table-bordered">
          <thead>
            <tr>
              <th rowspan="2" scope="col" class="p-0 p-md-0 text-center align-middle">#</th>
              <th rowspan="2" scope="col" class="p-0 p-md-0 text-center align-middle">タスク名</th>
              <th colspan="2" scope="col" class="p-0 p-md-0 text-center align-middle">期限</th>
              <th rowspan="2" scope="col" class="p-0 p-md-0 text-center align-middle">重要度</th>
              <th rowspan="2" scope="col" class="p-0 p-md-0 text-center align-middle">操作</th>
            </tr>
            <tr>
              <th scope="col" class="p-0 p-md-0 text-center align-middle">日</th>
              <th scope="col" class="p-0 p-md-0 text-center align-middle">時間</th>
            </tr>
          </thead>
          <tbody id="nc-tbody">
            {% for nc_task in nc_tasks %}
              <tr class="nc-task-item" data-deadline="{{ nc_task['deadline'] }}" data-task-id="{{ nc_task['task_id']}}" data-importance="{{ nc_task['importance'] }}">
                <th width="10%" scope="row" class="px-0 p-md-2 text-center align-middle">
                  <!-- aタグを削除、直接チェックボックスのみ -->
                  <input type="checkbox" class="check_box_fin rounded-circle px-1 py-2" data-task-id="{{ nc_task['task_id'] }}">
                </th>
                <td width="40%" class="px-0 p-md-0 text-center align-middle">
                  <label class="taskname form-check-label my-auto" >{{ nc_task['title']}}</label>
                </td>
                <td width="15%" class="px-0 p-md-0 text-center align-middle">
                  <label class="deaddate my-auto" >{{ nc_task['deadline'] | add_weekday }}</label>
                </td>
                <td width="10%" class="px-0 p-md-0 text-center align-middle">
                  <label class="deadtime my-auto">{{ nc_task['deadline'].strftime('%H:%M') }}</label>
                </td>
                <td width="10%" class="px-0 p-md-0 text-center align-middle">
                  <label class="importance my-auto">{{ nc_task['importance'] | convert_importance }}</label>
                </td>
                <td width="15%" class="px-0 p-md-0 text-center align-middle">
                  <div class="handle_buttons d-flex flex-row px-0 py-auto p-md-2 text-center justify-content-evenly align-middle gap-3 flex-grow">
                    <button type="button" class="btn btn-primary py-2 px-1 edit-task-btn" data-task-id="{{ nc_task['task_id'] }}">編集</button>
                    <button type="button" class="btn btn-danger py-2 px-1 delete-task-btn" data-task-id="{{ nc_task['task_id'] }}">削除</button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="fixed-button text-center align-middle">
      <a href="{{ url_for('add_task')}}">
      <button type="button" class="btn btn-primary font-size-l rounded-circle">+</button></a>
    </div>
    <div class="left-fixed-button text-center align-middle">
      <button type="button" class="btn btn-secondary font-size-l rounded-circle" data-bs-toggle="modal", data-bs-target="#addTaskModal">+</button>
    </div>

    <div class="row h-auto justify-content-center align-items-start">
      <div class="col-12 col-md-8 col-lg-6 col-xl-5">
        <div class="sort_buttons d-flex flex-row justify-content-end align-items-end px-0 py-1 gap-2"> 
        <h4 class="font-size-m m-auto">完了済みタスク</h4>
          {# <a href="{{ url_for('button_click', flg=3) }}"><button type="button" class="btn btn-outline-warning border-2 btn-sm" id="c-sort-importance">重要度順</button></a> #}
          <button type="button" class="btn btn-outline-warning border-2 btn-sm" id="c-sort-importance">重要度順</button>
          {# <a href="{{ url_for('button_click', flg=4) }}"><button type="button" class="btn btn-outline-secondary border-2 btn-sm" id="c-sort-day">日付順</button></a> #}
          <button type="button" class="btn btn-outline-secondary border-2 btn-sm" id="c-sort-day">日付順</button>
        </div>
        <table width="100%" class="table table-light table-hover table-bordered" id="c-table">
          <thead>
            <tr>
              {# <th rowspan="2" scope="col" class="p-0 p-md-2 text-center align-middle">#</th> #}
              <th rowspan="2" scope="col" class="p-0 p-md-0 text-center align-middle">タスク名</th>
              <th colspan="2" scope="col" class="p-0 p-md-0 text-center align-middle">期限</th>
              <th rowspan="2" scope="col" class="p-0 p-md-0 text-center align-middle">重要度</th>
              <th rowspan="2" scope="col" class="p-0 p-md-0 text-center align-middle">操作</th>
            </tr>
            <tr>
              <th scope="col" class="p-0 p-md-0 text-center align-middle">日</th>
              <th scope="col" class="p-0 p-md-0 text-center align-middle">時間</th>
            </tr>
          </thead>
          <tbody id="c-tbody">
            {% for c_task in c_tasks %}
              <tr class="c-task-item" data-deadline="{{ c_task['deadline'] }}" data-task-id="{{ c_task['task_id'] }}" data-importance="{{ c_task['importance'] }}">
                <td width="50%" class="px-0 p-md-0 text-center align-middle">
                  <label class="comp_task_name" >{{ c_task['title']}}</label>
                </td>
                <td width="15%" class="px-0 p-md-0 text-center align-middle">
                  <label class="comp_task_deadline" >{{ c_task['deadline'] | add_weekday }}</label>
                </td>
                <td width="10%"class="px-0 p-md-0 text-center align-middle">
                  <label class="comp_task_deadline" >{{ c_task['deadline'].strftime('%H:%M')}}</label>
                </td>
                <td width="10%"class="px-0 p-md-0 text-center align-middle">
                  <label class="importance my-auto" >{{ c_task['importance'] | convert_importance }}</label>
                </td>
                <td width="15%" class="px-0 p-md-0 text-center align-middle">
                  <div class="d-flex flex-row handle_buttons px-0 py-auto p-md-2 text-center justify-content-evenly align-middle gap-3 flex-grow">
                    <button type="button" class="btn btn-gray return_btn text-light py-2 px-1" data-task-id="{{ c_task['task_id'] }}">戻す</button>
                    <button type="button" class="btn btn-danger py-2 px-1 delete-task-btn" data-task-id="{{ c_task['task_id'] }}">削除</button>
                  </div>

                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    const convert_dl_time = function (num) {
      if (num === 0) return 15;
      else if (num === 1) return 30;
      else return 60;
    };
    const dl_time = {{ session.get('dl_time') }};
    localStorage.setItem('dl_time', convert_dl_time(dl_time));
    const is_first_slack = {{ session.get('is_first_slack') }};
    sessionStorage.setItem('is_first_slack', is_first_slack);
    const nc_v_mode = {{ session.get('nc_v_mode') }}
    const c_v_mode = {{ session.get('c_v_mode') }}
    localStorage.setItem('nc_v_mode', nc_v_mode);
    localStorage.setItem('c_v_mode', c_v_mode);
    const ncSortImportance = document.getElementById("nc-sort-importance");
    const ncSortDay = document.getElementById("nc-sort-day");
    const cSortImportance = document.getElementById("c-sort-importance");
    const cSortDay = document.getElementById("c-sort-day");
    if (nc_v_mode === 1) {
      ncSortImportance.classList.remove("btn-outline-warning");
      ncSortImportance.classList.add("btn-warning");
      ncSortDay.classList.add('btn-outline-secondary')
    }
    else if (nc_v_mode === 0) {
      ncSortDay.classList.remove("btn-outline-secondary");
      ncSortDay.classList.add("btn-secondary");
      ncSortImportance.classList.add('btn-outline-warning')
    }
    if (c_v_mode === 1) {
      cSortImportance.classList.remove("btn-outline-warning");
      cSortImportance.classList.add("btn-warning");
      cSortDay.classList.add('btn-outline-secondary')
    }
    else if (c_v_mode === 0) {
      cSortDay.classList.remove("btn-outline-secondary");
      cSortDay.classList.add("btn-secondary");
      cSortImportance.classList.add('btn-outline-warning')
    }


  </script>
  <script src="{{ url_for('static', filename='validate.js')}}"></script>
  <script src="{{ url_for('static', filename='script.js') }}"></script>
{% endblock %}
